<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock | QMI</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .stock-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--white);
      padding: 2rem;
    }

    .stock-header .container {
      max-width: 900px;
    }

    .stock-header a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .stock-header a:hover {
      color: var(--white);
    }

    .stock-title {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 1rem;
    }

    .stock-meta {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .stock-ticker {
      background: var(--accent);
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      font-weight: 700;
    }

    .article {
      max-width: 900px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    .banner {
      width: 100%;
      max-height: 450px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 3rem;
      display: none;
    }

    .banner.show {
      display: block;
    }

    .disclaimer {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 3rem;
    }

    .disclaimer strong {
      color: var(--primary);
    }

    #content {
      font-size: 1.05rem;
      line-height: 1.8;
      color: var(--primary);
    }

    #content h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 3rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent);
    }

    #content h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    #content p {
      margin-bottom: 1.5rem;
    }

    #content ul, #content ol {
      margin-bottom: 1.5rem;
      padding-left: 2rem;
    }

    #content li {
      margin-bottom: 0.75rem;
    }

    #content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 2rem 0;
    }

    #content iframe {
      max-width: 100%;
      border-radius: 8px;
    }

    .sources-section {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 2px solid var(--light-gray);
    }

    .sources-section h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    #sources {
      list-style: none;
      padding: 0;
    }

    #sources li {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--light-gray);
    }

    #sources a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
    }

    #sources a:hover {
      color: var(--accent);
    }

    @media (max-width: 768px) {
      .stock-title {
        font-size: 2rem;
      }

      .article {
        padding: 2rem 1.5rem;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">QMI</a>
      <div class="nav-links">
        <a href="search.html">Search</a>
        <a href="index.html">Home</a>
      </div>
    </div>
  </nav>

  <div class="stock-header">
    <div class="container">
      <a href="index.html">← Back to Research</a>
      <h1 class="stock-title" id="company">Loading...</h1>
      <div class="stock-meta" id="meta"></div>
    </div>
  </div>

  <article class="article">
    <img id="banner" class="banner" alt="" />

    <div class="disclaimer">
      <p><strong>Disclaimer:</strong> This content is for informational and educational purposes only and does not constitute investment advice. You should conduct your own due diligence and consult your financial advisor before making any investment decisions.</p>
    </div>

    <section id="content"></section>

    <section class="sources-section">
      <h3>Sources</h3>
      <ul id="sources"></ul>
    </section>
  </article>

  <footer>
    <p><strong>Qintal Market Intelligence (QMI)</strong></p>
    <p>All content is for informational purposes only and not investment advice.</p>
    <p>© 2026 Qintal Market Intelligence</p>
  </footer>

  <script type="module">
    import { supabase } from "./js/supabase.js";

    const urlParams = new URLSearchParams(window.location.search);
    const ticker = urlParams.get('ticker');

    if (!ticker) {
      document.querySelector('.article').innerHTML = '<div style="text-align:center;padding:3rem;"><h2>No ticker provided</h2><p><a href="index.html">Go back to home</a></p></div>';
    } else {
      loadStock(ticker);
    }

    async function loadStock(ticker) {
      try {
        const { data, error } = await supabase
          .from('research')
          .select('*')
          .eq('ticker', ticker)
          .single();

        if (error) throw error;

        document.title = `${data.company} (${data.ticker}) | QMI`;
        document.getElementById('company').textContent = data.company;
        
        document.getElementById('meta').innerHTML = `
          <span class="stock-ticker">${data.ticker}</span>
          <span style="color:rgba(255,255,255,0.7);">${data.country}</span>
          <span style="color:rgba(255,255,255,0.7);">${formatDate(data.created_at)}</span>
        `;

        if (data.banner_url) {
          const banner = document.getElementById('banner');
          banner.src = data.banner_url;
          banner.classList.add('show');
        }

        document.getElementById('content').innerHTML = data.content || '<p>No content available.</p>';

        if (data.sources) {
          try {
            const sources = typeof data.sources === 'string' ? JSON.parse(data.sources) : data.sources;
            document.getElementById('sources').innerHTML = sources.map(s => `
              <li><a href="${s.url}" target="_blank" rel="noopener">→ ${s.name}</a></li>
            `).join('');
          } catch (e) {
            document.querySelector('.sources-section').style.display = 'none';
          }
        } else {
          document.querySelector('.sources-section').style.display = 'none';
        }

      } catch (error) {
        console.error('Error:', error);
        document.querySelector('.article').innerHTML = '<div style="text-align:center;padding:3rem;"><h2>Error Loading Stock</h2><p>' + error.message + '</p><p><a href="index.html">Go back to home</a></p></div>';
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
  </script>
</body>
</html>
